<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Segredinho VIP</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: #000;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .chat-container {
            max-width: 500px;
            margin: 0 auto;
            background: #000;
            min-height: 100vh;
            position: relative;
        }

        .chat-header {
            background: #252525;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(174, 0, 255, 0.3);
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .profile-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ae00ff;
        }

        .profile-info h3 {
            color: white;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .profile-info p {
            color: #00ff88;
            font-size: 12px;
        }

        .saldo-display {
            margin-left: auto;
            background: rgba(174, 0, 255, 0.2);
            border: 1px solid #ae00ff;
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .chat-messages {
            padding: 90px 20px 100px;
            min-height: 100vh;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .message.received .message-content {
            background: #333;
            color: white;
            border-bottom-left-radius: 5px;
        }

        .message.sent .message-content {
            background: #ae00ff;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .audio-message {
            background: #444;
            border-radius: 20px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 280px;
            margin-bottom: 15px;
        }

        .audio-play-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #ae00ff;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .audio-play-btn:hover {
            background: #9300f5;
            transform: scale(1.05);
        }

        .audio-info {
            flex: 1;
        }

        .audio-duration {
            color: #ccc;
            font-size: 12px;
        }

        .audio-waveform {
            height: 30px;
            background: linear-gradient(90deg, #ae00ff, #9300f5, #ae00ff);
            border-radius: 15px;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }

        .waveform-progress {
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .chat-input-container {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: #252525;
            padding: 15px 20px;
            border-top: 1px solid #444;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #333;
            border-radius: 25px;
            padding: 8px 15px;
            transition: all 0.3s ease;
        }

        .chat-input-wrapper.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            padding: 8px 0;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input.disabled {
            cursor: not-allowed;
        }

        .chat-input::placeholder {
            color: #888;
        }

        .send-btn {
            background: #ae00ff;
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .send-btn:hover:not(:disabled) {
            background: #9300f5;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .send-btn:disabled:hover {
            transform: none;
            opacity: 0.5;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ae00ff;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .popup-content {
            background: #111;
            border: 2px solid #ae00ff;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            color: white;
            box-shadow: 0 0 20px #ae00ff;
        }

        .popup-content h2 {
            color: #ae00ff;
            margin-bottom: 15px;
        }

        .popup-content button {
            background: #ae00ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
        }

        .popup-content button:hover {
            background: #9300f5;
        }

        .message-time {
            font-size: 10px;
            color: #888;
            margin-top: 5px;
        }

        .pix-notification {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            padding: 12px 16px;
            border-radius: 18px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .blocked-message {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin: 20px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header do Chat -->
        <div class="chat-header">
            <button class="back-btn" onclick="voltarParaInicial()">←</button>
            <img id="profilePic" class="profile-pic" src="../wp-content/uploads/2025/04/logoCoroa.png" alt="Perfil">
            <div class="profile-info">
                <h3 id="profileName">Carregando...</h3>
                <p>Online agora</p>
            </div>
            <div class="saldo-display">
                Saldo: R$<span id="saldoChat">0,00</span>
            </div>
        </div>

        <!-- Mensagens do Chat -->
        <div class="chat-messages" id="chatMessages">
            <!-- Mensagens serão inseridas aqui dinamicamente -->
        </div>

        <!-- Indicador de digitação -->
        <div class="typing-indicator" id="typingIndicator">
            <img class="profile-pic" src="../wp-content/uploads/2025/04/logoCoroa.png" alt="Perfil" style="width: 30px; height: 30px;">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Input de mensagem -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper" id="inputWrapper">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="Digite sua mensagem..."
                    disabled
                >
                <button class="send-btn" id="sendBtn" onclick="enviarMensagem()" disabled>
                    ➤
                </button>
            </div>
        </div>
    </div>

    <!-- Popup de presente -->
    <div class="popup" id="presentePopup">
        <div class="popup-content">
            <h2>🎁 Presente Recebido!</h2>
            <p>Você ganhou <strong>R$ 50,00</strong> de presente!</p>
            <p style="font-size: 14px; color: #ccc; margin-top: 10px;">
                Continue conversando para receber mais presentes!
            </p>
            <button onclick="fecharPopupPresente()">Continuar Chat</button>
        </div>
    </div>

    <!-- Popup Premium -->
    <div class="popup" id="premiumPopup">
        <div class="popup-content">
            <h2>🔒 Acesso Premium</h2>
            <p>Para continuar conversando e receber mais presentes, você precisa do acesso Premium!</p>
            <div style="background: #222; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <p style="color: #ae00ff; font-weight: 600;">✨ Premium VIP - R$ 14,90</p>
                <p style="font-size: 12px; color: #ccc;">Chat ilimitado + Presentes exclusivos</p>
            </div>
            <button onclick="window.open('https://pay.kirvano.com/0396ebe8-c9ce-4ef2-9b3c-ad1adbcac08b', '_blank')">
                Assinar Premium
            </button>
        </div>
    </div>

    <script>
        // Variáveis globais
        let canSendMessage = false; // Controla se pode enviar mensagem
        let audioCount = 0;
        let messageCount = 0;
        let currentAudio = null;
        let isSecondMatch = false;
        let chatData = {
            profileName: 'Perfil',
            profilePic: '../wp-content/uploads/2025/04/logoCoroa.png',
            saldo: '0,00'
        };

        // Áudios disponíveis
        const audios = [
            '../assets/audios/audio1.mp4',
            '../assets/audios/audio2.mp4', 
            '../assets/audios/audio3.mp4'
        ];

        // Mensagens das "coroas"
        const coroaMessages = [
            "Oi gatinho! Adorei seu perfil 😘",
            "Você é muito charmoso! Me conta mais sobre você...",
            "Que bom que deu match! Estava esperando alguém assim 💕",
            "Adoro homens interessantes como você 😍",
            "Me fala, o que você mais gosta de fazer?",
            "Você tem um sorriso lindo! 😊",
            "Estou curiosa para te conhecer melhor...",
            "Que tal conversarmos mais? 💬"
        ];

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando chat...');
            
            // Carregar dados do localStorage
            loadChatData();
            
            // Verificar se é segundo match
            isSecondMatch = localStorage.getItem('isSecondMatch') === 'true';
            console.log('🎯 É segundo match:', isSecondMatch);
            
            // Iniciar conversa
            setTimeout(() => {
                iniciarConversa();
            }, 1000);

            // Event listener para Enter no input
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && canSendMessage && !this.disabled) {
                    enviarMensagem();
                }
            });
        });

        function loadChatData() {
            // Carregar dados do perfil
            const profileName = localStorage.getItem('chatPerfilNome') || 'Perfil';
            const profilePic = localStorage.getItem('chatPerfilFoto') || '../wp-content/uploads/2025/04/logoCoroa.png';
            const saldo = localStorage.getItem('chatSaldo') || '0.00';

            chatData.profileName = profileName;
            chatData.profilePic = profilePic;
            chatData.saldo = parseFloat(saldo).toFixed(2).replace('.', ',');

            // Atualizar interface
            document.getElementById('profileName').textContent = profileName;
            document.getElementById('profilePic').src = profilePic;
            document.getElementById('saldoChat').textContent = chatData.saldo;

            console.log('📊 Dados do chat carregados:', chatData);
        }

        function iniciarConversa() {
            console.log('💬 Iniciando conversa...');
            
            // Primeira mensagem da coroa
            setTimeout(() => {
                receberMensagem(getRandomCoroaMessage());
            }, 500);

            // Primeiro áudio após 3 segundos
            setTimeout(() => {
                receberAudio();
            }, 3000);
        }

        function receberMensagem(texto) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Mostrar indicador de digitação
            mostrarDigitacao();
            
            setTimeout(() => {
                // Esconder indicador de digitação
                esconderDigitacao();
                
                // Criar mensagem
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message received';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = texto;
                
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                messageTime.textContent = new Date().toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageContent.appendChild(messageTime);
                messageDiv.appendChild(messageContent);
                messagesContainer.appendChild(messageDiv);
                
                // Scroll para baixo
                scrollToBottom();
                
                console.log('📨 Mensagem recebida:', texto);
            }, 1500);
        }

        function receberAudio() {
            audioCount++;
            console.log(`🎵 Recebendo áudio ${audioCount}...`);
            
            const messagesContainer = document.getElementById('chatMessages');
            
            // Mostrar indicador de digitação
            mostrarDigitacao();
            
            setTimeout(() => {
                // Esconder indicador de digitação
                esconderDigitacao();
                
                // Criar mensagem de áudio
                const audioDiv = document.createElement('div');
                audioDiv.className = 'audio-message';
                
                const audioSrc = audios[(audioCount - 1) % audios.length];
                
                audioDiv.innerHTML = `
                    <button class="audio-play-btn" onclick="playAudio('${audioSrc}', this)">
                        ▶
                    </button>
                    <div class="audio-info">
                        <div class="audio-waveform">
                            <div class="waveform-progress"></div>
                        </div>
                        <div class="audio-duration">0:${String(15 + Math.floor(Math.random() * 30)).padStart(2, '0')}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(audioDiv);
                scrollToBottom();
                
                console.log('🎵 Áudio adicionado ao chat');
            }, 2000);
        }

        function playAudio(src, button) {
            console.log('🎵 Reproduzindo áudio:', src);
            
            // Parar áudio atual se existir
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            // Criar novo áudio
            currentAudio = new Audio(src);
            
            // Atualizar botão
            button.innerHTML = '⏸';
            button.disabled = true;
            
            // Simular progresso
            const progressBar = button.parentElement.querySelector('.waveform-progress');
            let progress = 0;
            const duration = 15 + Math.floor(Math.random() * 30); // Duração simulada
            
            const progressInterval = setInterval(() => {
                progress += 100 / (duration * 10); // Atualizar a cada 100ms
                progressBar.style.width = Math.min(progress, 100) + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    button.innerHTML = '▶';
                    button.disabled = false;
                    progressBar.style.width = '0%';
                    
                    // DESBLOQUEAR ENVIO DE MENSAGEM APÓS ÁUDIO
                    desbloquearEnvioMensagem();
                    
                    console.log('✅ Áudio finalizado, envio de mensagem desbloqueado');
                }
            }, 100);
            
            // Simular reprodução
            setTimeout(() => {
                if (currentAudio) {
                    currentAudio.play().catch(e => console.log('Erro ao reproduzir áudio:', e));
                }
            }, 100);
        }

        function desbloquearEnvioMensagem() {
            canSendMessage = true;
            
            const inputWrapper = document.getElementById('inputWrapper');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // Remover classes de desabilitado
            inputWrapper.classList.remove('disabled');
            messageInput.classList.remove('disabled');
            
            // Habilitar elementos
            messageInput.disabled = false;
            sendBtn.disabled = false;
            
            // Atualizar placeholder
            messageInput.placeholder = 'Digite sua mensagem...';
            
            console.log('🔓 Envio de mensagem desbloqueado');
        }

        function bloquearEnvioMensagem() {
            canSendMessage = false;
            
            const inputWrapper = document.getElementById('inputWrapper');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // Adicionar classes de desabilitado
            inputWrapper.classList.add('disabled');
            messageInput.classList.add('disabled');
            
            // Desabilitar elementos
            messageInput.disabled = true;
            sendBtn.disabled = true;
            
            // Atualizar placeholder
            messageInput.placeholder = 'Aguarde o próximo áudio...';
            
            console.log('🔒 Envio de mensagem bloqueado');
        }

        function enviarMensagem() {
            if (!canSendMessage) {
                console.log('❌ Envio bloqueado');
                return;
            }
            
            const messageInput = document.getElementById('messageInput');
            const texto = messageInput.value.trim();
            
            if (!texto) return;
            
            console.log('📤 Enviando mensagem:', texto);
            
            const messagesContainer = document.getElementById('chatMessages');
            
            // Criar mensagem enviada
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = texto;
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageContent.appendChild(messageTime);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // Limpar input
            messageInput.value = '';
            
            // Scroll para baixo
            scrollToBottom();
            
            // BLOQUEAR ENVIO APÓS MENSAGEM
            bloquearEnvioMensagem();
            
            messageCount++;
            
            // Lógica de resposta baseada no número de mensagens
            setTimeout(() => {
                if (messageCount === 1) {
                    // Primeira mensagem: resposta + presente
                    receberMensagem("Que fofo! Adorei sua mensagem 😘");
                    setTimeout(() => {
                        mostrarPresente();
                    }, 2000);
                    
                    // Próximo áudio em 5 segundos
                    setTimeout(() => {
                        receberAudio();
                    }, 5000);
                    
                } else if (messageCount === 2) {
                    // Segunda mensagem: resposta
                    receberMensagem("Você é muito interessante! 💕");
                    
                    // Se é segundo match, mostrar popup premium
                    if (isSecondMatch) {
                        setTimeout(() => {
                            mostrarPopupPremium();
                        }, 3000);
                    } else {
                        // Próximo áudio
                        setTimeout(() => {
                            receberAudio();
                        }, 4000);
                    }
                    
                } else {
                    // Mensagens subsequentes
                    receberMensagem(getRandomCoroaMessage());
                    
                    // Continuar ciclo de áudios
                    setTimeout(() => {
                        receberAudio();
                    }, 3000);
                }
            }, 1000);
        }

        function mostrarPresente() {
            console.log('🎁 Mostrando presente...');
            
            // Atualizar saldo
            let saldoAtual = parseFloat(chatData.saldo.replace(',', '.'));
            saldoAtual += 50;
            chatData.saldo = saldoAtual.toFixed(2).replace('.', ',');
            
            // Atualizar interface
            document.getElementById('saldoChat').textContent = chatData.saldo;
            
            // Salvar no localStorage
            localStorage.setItem('chatSaldo', saldoAtual.toFixed(2));
            localStorage.setItem('saldoUsuario', saldoAtual.toFixed(2));
            
            // Mostrar notificação no chat
            const messagesContainer = document.getElementById('chatMessages');
            const pixNotification = document.createElement('div');
            pixNotification.className = 'pix-notification';
            pixNotification.innerHTML = '🎁 Você recebeu R$ 50,00 de presente! 💰';
            messagesContainer.appendChild(pixNotification);
            scrollToBottom();
            
            // Mostrar popup
            document.getElementById('presentePopup').style.display = 'flex';
        }

        function mostrarPopupPremium() {
            console.log('💎 Mostrando popup premium...');
            document.getElementById('premiumPopup').style.display = 'flex';
        }

        function fecharPopupPresente() {
            document.getElementById('presentePopup').style.display = 'none';
        }

        function mostrarDigitacao() {
            document.getElementById('typingIndicator').style.display = 'flex';
            scrollToBottom();
        }

        function esconderDigitacao() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getRandomCoroaMessage() {
            return coroaMessages[Math.floor(Math.random() * coroaMessages.length)];
        }

        function voltarParaInicial() {
            // Salvar saldo atual
            const saldoAtual = document.getElementById('saldoChat').textContent;
            localStorage.setItem('saldoUsuario', saldoAtual.replace(',', '.'));
            
            // Voltar para página inicial
            window.location.href = '../inicial.html';
        }
    </script>
</body>
</html>
